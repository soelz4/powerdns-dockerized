services:
  db:
    image: postgres:15.14-alpine3.22
    container_name: postgres
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pdns_admin -d pdns"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      - POSTGRES_DB=pdns
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=1234
    volumes:
      - pdns-data:/var/lib/postgresql/data
      # - ./pdns-schema.sql:/docker-entrypoint-initdb.d/schema.sql

  pdns-auth:
    # image: powerdns/pdns-auth-49:4.9.9
    image: pschiffe/pdns-pgsql:4.9-alpine
    container_name: pdns-auth
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      - PDNS_gpgsql_host=postgres
      - PDNS_gpgsql_port=5432
      - PDNS_gpgsql_user=postgres
      - PDNS_gpgsql_password=1234
      - PDNS_gpgsql_dbname=pdns
      - PDNS_api=yes
      - PDNS_api_key=1234
      - PDNS_webserver=yes
      - PDNS_webserver_address=0.0.0.0
      - PDNS_webserver-allow-from=0.0.0.0/0
    ports:
      - "53:53"
      - "53:53/udp"
      - "8081:8081"
    # volumes:
    # - ./pdns.conf:/etc/powerdns/pdns.conf
    # - ./pdns-auth/config:/etc/powerdns

  pdns-recursor:
    image: powerdns/pdns-recursor-50:5.0.12
    container_name: pdns-recursor
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      - PDNS_RECURSOR_API_KEY
    ports:
      - "2053:53"
      - "2053:53/udp"
      - "8082:8082"

  pdns-dnsdist:
    image: powerdns/dnsdist-19:1.9.11
    container_name: pdns-dnsdist
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      - DNSDIST_API_KEY
    links:
      - pdns-recursor
      - pdns-auth
    ports:
      - "3053:53"
      - "3053:53/udp"
      - "5199:5199"
      - "8083:8083"

  nginx:
    image: nginx:1.29-alpine3.22
    container_name: nginx
    restart: always
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      # - ./nginx/html:/usr/share/nginx/html

  app:
    image: powerdnsadmin/pda-legacy:master
    container_name: powerdns_admin
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: 50m
    environment:
      - PDNS_ADMIN_SQLA_DB_TYPE=postgres
      - PDNS_ADMIN_SQLA_DB_HOST=postgres
      - PDNS_ADMIN_SQLA_DB_PORT=5432
      - PDNS_ADMIN_SQLA_DB_USER=postgres
      - PDNS_ADMIN_SQLA_DB_PASSWORD=1234
      - PDNS_API_URL=http://pdns-auth:8081
      - PDNS_VERSION=4.9
      - PDNS_API_KEY=1234

volumes:
  pdns-data:
    driver: local
